<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Intelligence Dashboard ‚Äî ·ÄÄ·Ä≠·ÄØ·Äï·Ä≠·ÄØ·ÄÑ·Ä∫ AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Padauk:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', 'Padauk', sans-serif; background-color: #000000; color: #f5f5f7; }
        
        /* Apple-style Glassmorphism */
        .glass-card {
            background: rgba(28, 28, 30, 0.65);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            border-radius: 20px;
        }

        /* Apple Border Glow */
        .apple-glow:hover {
            box-shadow: 0 0 20px rgba(0, 113, 227, 0.4);
            border-color: rgba(0, 113, 227, 0.5);
            transform: scale(1.01);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* Apple Button */
        .apple-btn {
            background: rgba(0, 113, 227, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }
        .apple-btn:hover {
            background: rgba(0, 122, 255, 1);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 113, 227, 0.3);
        }

        .neon-text { text-shadow: 0 0 15px rgba(0, 113, 227, 0.6); }
        .ticker-move { animation: ticker 35s linear infinite; }
        @keyframes ticker { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        
        /* Custom Scrollbar (Invisible/Apple-like) */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        /* Animations for News Cards */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .news-card { animation: fadeIn 0.5s ease-out forwards; }

        /* Static subtle border glow only (no moving colors) */
        .market-glow-card {
            position: relative;
            isolation: isolate;
        }
        .market-glow-card::before,
        .market-glow-card::after {
            content: none;
        }
        .market-glow-card {
            box-shadow: 0 0 0 1px rgba(255,255,255,0.10), 0 0 14px rgba(120,160,255,0.16);
        }
        .market-glow-card:hover {
            box-shadow: 0 0 0 1px rgba(255,255,255,0.14), 0 0 18px rgba(120,160,255,0.22);
        }
    </style>
</head>
<body class="overflow-x-hidden">

    <!-- Navbar & Marquee -->
    <nav class="fixed top-0 w-full z-50 bg-[#000000]/70 backdrop-blur-xl border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center backdrop-blur-md border border-white/10">
                         <span class="font-bold text-white text-sm">SP</span>
                    </div>
                    <span class="text-lg font-semibold tracking-tight text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.3)]">
                        Trading Intelligence Dashboard
                    </span>
                </div>
                <div class="hidden md:flex space-x-8 text-[13px] tracking-wide text-gray-300 font-medium">
                    <a href="#" class="hover:text-white transition ease-out duration-300">·ÄÄ·Äõ·ÄÖ·Ä∫·Äï·Äê·Ä≠·ÄØ</a>
                    <a href="#" class="hover:text-white transition ease-out duration-300">·ÄÖ·Äê·Ä±·Ä¨·Ä∑·Äô·Äª·Ä¨·Ä∏</a>
                    <a href="#" class="hover:text-white transition ease-out duration-300">·ÄÄ·ÄØ·Äî·Ä∫·ÄÖ·Ää·Ä∫·Äô·Äª·Ä¨·Ä∏</a>
                    <a href="#" class="hover:text-white transition ease-out duration-300">AI ·Ä°·ÄÄ·Äº·Ä∂·Äï·Äº·ÄØ·ÄÅ·Äª·ÄÄ·Ä∫</a>
                </div>
                <div class="flex items-center gap-3">
                     <div id="yangon-weather" class="text-[11px] font-medium text-blue-400 bg-blue-500/10 px-3 py-1.5 rounded-full border border-blue-500/20 flex items-center gap-2 backdrop-blur-md">
                        <span>üå¶Ô∏è YGN</span>
                    </div>
                    <div id="conn-badge" class="text-[11px] font-medium text-gray-300 bg-white/5 px-3 py-1.5 rounded-full border border-white/10 flex items-center gap-2 backdrop-blur-md font-[Padauk]">
                        <span class="w-2 h-2 rounded-full bg-gray-500"></span>
                        <span>·ÄÅ·Äª·Ä≠·Äê·Ä∫·ÄÜ·ÄÄ·Ä∫·Äî·Ä±...</span>
                    </div>
                    <button class="apple-btn text-white px-5 py-1.5 text-xs font-medium tracking-wide">
                        ·ÄÅ·Äª·Ä≠·Äê·Ä∫·ÄÜ·ÄÄ·Ä∫·Äô·Ää·Ä∫
                    </button>
                </div>
            </div>
        </div>
        <!-- Live Ticker -->
        <div class="h-8 bg-black/40 flex items-center overflow-hidden border-t border-gray-800">
            <div class="whitespace-nowrap ticker-move text-xs font-mono text-gray-400" id="marquee-ticker">
                BTC: Loading... ‚Ä¢ ETH: Loading... ‚Ä¢ GOLD: $5,081 ‚Ä¢ OIL: $78.20 ‚Ä¢ SOL: Loading...
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-28 pb-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto space-y-6">
        
        <!-- Top Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- BTC Card -->
            <div class="glass-card market-glow-card p-6 apple-glow cursor-default relative overflow-hidden group">
                <div class="absolute inset-0 bg-gradient-to-br from-orange-500/5 to-transparent pointer-events-none"></div>
                <div class="flex justify-between items-start z-10 relative">
                    <div>
                        <p class="text-[11px] uppercase tracking-wider text-gray-400 font-semibold mb-1">Bitcoin</p>
                        <h3 class="text-3xl font-medium tracking-tight text-white transition-all duration-300" id="price-btc">$67,200</h3>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 flex items-center justify-center">
                        <svg class="w-4 h-4 text-orange-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                    </div>
                </div>
                <div class="mt-4 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-[10px] text-green-400 font-medium tracking-wide">LIVE</span>
                    <span id="btc-last" class="text-[10px] text-gray-500 font-mono">‚Äî</span>
                    <span id="btc-delta" class="text-[10px] text-gray-400 font-mono">‚Äî</span>
                </div>
            </div>

            <!-- ETH Card -->
            <div class="glass-card market-glow-card p-6 apple-glow cursor-default relative overflow-hidden group">
                <div class="absolute inset-0 bg-gradient-to-br from-purple-500/5 to-transparent pointer-events-none"></div>
                <div class="flex justify-between items-start z-10 relative">
                    <div>
                        <p class="text-[11px] uppercase tracking-wider text-gray-400 font-semibold mb-1">Ethereum</p>
                        <h3 class="text-3xl font-medium tracking-tight text-white transition-all duration-300" id="price-eth">$2,600</h3>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center">
                         <svg class="w-4 h-4 text-purple-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L2 12l10 10 10-10L12 2zm0 4.2L17.8 11 12 16.8 6.2 11 12 6.2z"/></svg>
                    </div>
                </div>
                <div class="mt-4 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-[10px] text-green-400 font-medium tracking-wide">LIVE</span>
                    <span id="eth-last" class="text-[10px] text-gray-500 font-mono">‚Äî</span>
                    <span id="eth-delta" class="text-[10px] text-gray-400 font-mono">‚Äî</span>
                </div>
            </div>

            <!-- Gold Card (TradingView live) -->
            <div class="glass-card market-glow-card p-6 apple-glow cursor-default relative overflow-hidden group">
                <div class="absolute inset-0 bg-gradient-to-br from-yellow-500/5 to-transparent pointer-events-none"></div>
                <div class="flex justify-between items-start z-10 relative mb-3">
                    <div>
                        <p class="text-[11px] uppercase tracking-wider text-gray-400 font-semibold mb-1">Gold (XAU)</p>
                        <h3 class="text-xs tracking-wide text-yellow-200/80" id="price-gold">TradingView Live</h3>
                    </div>
                    <span class="text-[10px] font-mono text-yellow-500/80 border border-yellow-500/20 px-2 py-0.5 rounded-full">TVC:GOLD</span>
                </div>
                <div class="tradingview-widget-container">
                    <div class="tradingview-widget-container__widget"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-single-quote.js" async>
                    { "symbol": "TVC:GOLD", "width": "100%", "colorTheme": "dark", "isTransparent": true, "locale": "en" }
                    </script>
                </div>
            </div>

            <!-- Oil Card (TradingView live) -->
            <div class="glass-card market-glow-card p-6 apple-glow cursor-default relative overflow-hidden group">
                 <div class="absolute inset-0 bg-gradient-to-br from-red-500/5 to-transparent pointer-events-none"></div>
                <div class="flex justify-between items-start z-10 relative mb-3">
                    <div>
                        <p class="text-[11px] uppercase tracking-wider text-gray-400 font-semibold mb-1">Crude Oil</p>
                        <h3 class="text-xs tracking-wide text-red-200/80" id="price-oil">TradingView Live</h3>
                    </div>
                     <span class="text-[10px] font-mono text-red-500/80 border border-red-500/20 px-2 py-0.5 rounded-full">TVC:UKOIL</span>
                </div>
                <div class="tradingview-widget-container">
                    <div class="tradingview-widget-container__widget"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-single-quote.js" async>
                    { "symbol": "TVC:UKOIL", "width": "100%", "colorTheme": "dark", "isTransparent": true, "locale": "en" }
                    </script>
                </div>
            </div>
        </div>

        <!-- Main Content Area: AI Intelligence & News Feed -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-auto min-h-[500px]">
            
            <!-- LEFT: AI Intelligence Panel (Expanded) -->
            <div class="lg:col-span-2 glass-card p-8 flex flex-col relative overflow-hidden">
                <div class="absolute top-0 right-0 p-32 bg-blue-500/10 blur-[100px] rounded-full pointer-events-none"></div>
                
                <div class="flex items-center justify-between mb-8 border-b border-white/10 pb-4">
                    <h3 class="text-2xl font-bold tracking-tight text-white flex items-center gap-3">
                        <span class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-indigo-600 flex items-center justify-center text-sm shadow-lg shadow-blue-500/30">ü§ñ</span>
                        ·ÄÄ·Ä≠·ÄØ·Äï·Ä≠·ÄØ·ÄÑ·Ä∫ AI ·Ä°·ÄÄ·Äº·Ä∂·Äï·Äº·ÄØ·ÄÅ·Äª·ÄÄ·Ä∫
                    </h3>
                    <div class="flex items-center gap-2 px-3 py-1 bg-green-500/10 border border-green-500/20 rounded-full">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                        <span class="text-xs font-semibold text-green-400 tracking-wide">LIVE ANALYSIS</span>
                    </div>
                </div>

                <div id="ai-analysis-feed" class="space-y-6 flex-1">
                    <!-- Placeholder -->
                    <div class="animate-pulse space-y-4">
                        <div class="h-4 bg-white/5 rounded w-1/4"></div>
                        <div class="h-32 bg-white/5 rounded-2xl border border-white/5"></div>
                    </div>
                </div>

                <!-- Manual AI Update Controls -->
                <div class="mt-8 space-y-3">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <input id="openrouter-key" type="password" placeholder="OpenRouter API Key (sk-or-...)" class="md:col-span-2 w-full py-3 px-4 rounded-xl bg-white/5 border border-white/10 text-sm text-gray-200 placeholder:text-gray-500 focus:outline-none focus:border-blue-500/50" />
                        <select id="openrouter-model" class="w-full py-3 px-3 rounded-xl bg-white/5 border border-white/10 text-sm text-gray-200 focus:outline-none focus:border-blue-500/50">
                            <option value="openrouter/auto">Auto (OpenRouter)</option>
                            <option value="openai/gpt-4o-mini">OpenAI GPT-4o mini</option>
                            <option value="google/gemini-2.0-flash-001">Google Gemini 2.0 Flash</option>
                            <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                            <option value="meta-llama/llama-3.3-70b-instruct">Llama 3.3 70B</option>
                        </select>
                        <button id="update-ai-news-btn" class="py-3 px-4 rounded-xl bg-blue-600 hover:bg-blue-500 transition flex items-center justify-center gap-2 text-sm font-medium text-white shadow-lg shadow-blue-500/20">
                            üß† ·Äû·Äê·ÄÑ·Ä∫·Ä∏ Update ·Äê·ÄÑ·Ä∫·Äô·Äö·Ä∫
                        </button>
                    </div>
                    <p id="ai-update-status" class="text-xs text-gray-400 font-[Padauk]">Manual mode: API key + model ·Äõ·ÄΩ·Ä±·Ä∏·Äï·Äº·ÄÆ·Ä∏ ·ÄÅ·Äú·ÄØ·Äê·Ä∫·Äî·Äæ·Ä≠·Äï·Ä∫·Äô·Äæ·Äï·Ä≤ AI news/update ·Äë·ÄØ·Äê·Ä∫·Äï·Ä´·Äô·Äö·Ä∫·Åã</p>
                </div>
            </div>

    <div class="glass-card p-6 flex flex-col h-full relative">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2 font-[Padauk]">
                        üì∞ Crypto ·Äû·Äê·ÄÑ·Ä∫·Ä∏·Äê·Ä≠·ÄØ·Äô·Äª·Ä¨·Ä∏
                    </h3>
                    <span class="text-xs text-gray-400 font-[Padauk]">·ÅÉ·ÅÄ ·Äô·Ä≠·Äî·ÄÖ·Ä∫·Äê·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏ Update</span>
                </div>
                
                <div class="flex-1 overflow-y-auto space-y-5 pr-1 relative" id="news-feed">
                    <!-- Default Static Content (Fallback) -->
                    <div class="news-card p-5 rounded-xl bg-white/5 border border-white/5 mb-3">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[11px] font-bold tracking-wider text-blue-400 bg-blue-500/10 px-2 py-0.5 rounded uppercase">SYSTEM</span>
                            <span class="text-[11px] text-gray-400 font-[Padauk]">Now</span>
                        </div>
                        <h4 class="text-base font-medium text-gray-100 leading-snug font-[Padauk]">System Connecting... (Connecting to Live Feed)</h4>
                    </div>
                </div>
                
                <!-- Bottom Fade -->
                <div class="absolute bottom-0 left-0 w-full h-12 bg-gradient-to-t from-[#1c1c1e] to-transparent pointer-events-none rounded-b-2xl"></div>
            </div>
        </div>

        <!-- Market Grid (Commodities & Forex) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="glass-card p-5 rounded-2xl">
                <h4 class="text-gray-400 text-sm mb-3">Forex (Major Pair ·Äô·Äª·Ä¨·Ä∏)</h4>
                <div class="space-y-3">
                    <div class="flex justify-between text-sm"><span class="text-gray-300">EUR/USD</span> <span class="text-green-400">1.0845 (+0.1%)</span></div>
                    <div class="flex justify-between text-sm"><span class="text-gray-300">GBP/USD</span> <span class="text-red-400">1.2630 (-0.2%)</span></div>
                    <div class="flex justify-between text-sm"><span class="text-gray-300">USD/JPY</span> <span class="text-green-400">151.20 (+0.5%)</span></div>
                </div>
            </div>
            <div class="glass-card p-5 rounded-2xl">
                <h4 class="text-gray-400 text-sm mb-3">Tech ·ÄÖ·Äê·Ä±·Ä¨·Ä∑·Äô·Äª·Ä¨·Ä∏</h4>
                <div class="space-y-3">
                    <div class="flex justify-between text-sm"><span class="text-gray-300">NVDA</span> <span class="text-green-400">$950.40 (+3.2%)</span></div>
                    <div class="flex justify-between text-sm"><span class="text-gray-300">TSLA</span> <span class="text-red-400">$175.20 (-1.5%)</span></div>
                    <div class="flex justify-between text-sm"><span class="text-gray-300">AAPL</span> <span class="text-gray-400">$172.50 (0.0%)</span></div>
                </div>
            </div>
            <div class="glass-card p-5 rounded-2xl bg-gradient-to-br from-blue-900/20 to-purple-900/20">
                <h4 class="text-gray-400 text-sm mb-2">Fear & Greed ·Ä°·Ää·ÄΩ·Äæ·Äî·Ä∫·Ä∏·ÄÄ·Ä≠·Äî·Ä∫·Ä∏</h4>
                <div class="flex items-center justify-center h-24">
                    <div class="text-center">
                        <span class="text-4xl font-bold text-green-400">79</span>
                        <p class="text-xs text-green-300 mt-1">·Äú·Ä±·Ä¨·Äò·Ä°·Äú·ÄΩ·Äî·Ä∫ (Extreme Greed)</p>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // === PRICE + TICKER (CoinGecko REST fallback) ===
        const els = {
            btc: document.getElementById('price-btc'),
            eth: document.getElementById('price-eth'),
            marquee: document.getElementById('marquee-ticker'),
            gold: document.getElementById('price-gold'),
            oil: document.getElementById('price-oil'),
            weather: document.getElementById('yangon-weather'),
            aiFeed: document.getElementById('ai-analysis-feed'),
            newsFeed: document.getElementById('news-feed'),
            conn: document.getElementById('conn-badge'),
            openrouterKey: document.getElementById('openrouter-key'),
            modelSelect: document.getElementById('openrouter-model'),
            updateBtn: document.getElementById('update-ai-news-btn'),
            updateStatus: document.getElementById('ai-update-status'),
        };

        function fmtUSD(n, decimals = 2) {
            try {
                const num = Number(n);
                if (!Number.isFinite(num)) return '$' + n;
                return '$' + num.toLocaleString(undefined, {
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals,
                });
            } catch {
                return '$' + n;
            }
        }

        // === Real-time (best effort): Binance WebSocket, fallback to REST ===
        let lastBtc = null;
        let lastEth = null;

        function flashPrice(el, dir) {
            if (!el) return;
            const base = 'text-3xl font-medium tracking-tight text-white transition-all duration-300';
            const up = 'text-3xl font-medium tracking-tight text-green-400 transition-all duration-300';
            const down = 'text-3xl font-medium tracking-tight text-red-400 transition-all duration-300';
            el.className = dir > 0 ? up : dir < 0 ? down : base;
            setTimeout(() => { el.className = base; }, 650);
        }

        function setLast(id, label) {
            const el = document.getElementById(id);
            if (!el) return;
            el.textContent = label;
        }

        function setDelta(id, delta) {
            const el = document.getElementById(id);
            if (!el) return;

            const base = 'text-[10px] font-mono';
            if (!Number.isFinite(delta) || delta == 0) {
                el.className = `${base} text-gray-500`;
                el.textContent = '‚Äî';
                return;
            }

            const up = delta > 0;
            const arrow = up ? '‚ñ≤' : '‚ñº';
            const sign = up ? '+' : '';
            el.className = `${base} ${up ? 'text-green-400' : 'text-red-400'}`;
            el.textContent = `${arrow} ${sign}${delta.toFixed(2)}`;
        }

        // Connection badge state (WS vs REST)
        let wsLastTs = 0;

        function setConnBadge(mode, label) {
            if (!els.conn) return;

            const baseWrap = 'text-[11px] font-medium px-3 py-1.5 rounded-full border flex items-center gap-2 backdrop-blur-md font-[Padauk]';
            if (mode === 'WS') els.conn.className = `${baseWrap} text-green-300 bg-green-500/10 border-green-500/20`;
            else if (mode === 'REST') els.conn.className = `${baseWrap} text-yellow-300 bg-yellow-500/10 border-yellow-500/20`;
            else els.conn.className = `${baseWrap} text-red-300 bg-red-500/10 border-red-500/20`;

            const spans = els.conn.querySelectorAll('span');
            const dot = spans[0];
            const txt = spans[1];

            if (dot) {
                const baseDot = 'w-2 h-2 rounded-full';
                if (mode === 'WS') dot.className = `${baseDot} bg-green-500 animate-pulse`;
                else if (mode === 'REST') dot.className = `${baseDot} bg-yellow-400 animate-pulse`;
                else dot.className = `${baseDot} bg-red-500`;
            }
            if (txt) txt.textContent = label;
        }

        function markWS(label = 'WS ·Äê·Ä≠·ÄØ·ÄÄ·Ä∫·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫') {
            wsLastTs = Date.now();
            setConnBadge('WS', label);
        }

        function markREST(label = 'REST ·Ä°·Äï·Ä∫·Äí·Ä≠·Äê·Ä∫') {
            if (Date.now() - wsLastTs > 15000) setConnBadge('REST', label);
        }

        function markERR(label = 'Offline') {
            if (Date.now() - wsLastTs > 15000) setConnBadge('ERR', label);
        }

        function updateMarquee({ btc, eth, note }) {
            const nowStr = new Date().toLocaleTimeString();
            if (!els.marquee) return;
            const btcPart = (typeof btc === 'number') ? `BTC: ${fmtUSD(btc, 0)}` : 'BTC: N/A';
            const ethPart = (typeof eth === 'number') ? `ETH: ${fmtUSD(eth, 0)}` : 'ETH: N/A';
            els.marquee.textContent = `${btcPart} ‚Ä¢ ${ethPart} ‚Ä¢ GOLD: TVC:GOLD (live) ‚Ä¢ OIL: TVC:UKOIL (live) ‚Ä¢ ${note ?? 'Updated'}: ${nowStr}`;
        }

        function startBinanceWS() {
            // trades stream (ticks)
            try {
                const ws = new WebSocket('wss://stream.binance.com:9443/stream?streams=btcusdt@trade/ethusdt@trade');

                ws.onopen = () => {
                    setLast('btc-last', 'ws connected');
                    setLast('eth-last', 'ws connected');
                    markWS('WS ·ÄÅ·Äª·Ä≠·Äê·Ä∫·ÄÜ·ÄÄ·Ä∫·Äï·Äº·ÄÆ·Ä∏');
                };

                ws.onmessage = (evt) => {
                    try {
                        const msg = JSON.parse(evt.data);
                        const stream = msg?.stream;
                        const p = Number(msg?.data?.p);
                        const nowStr = new Date().toLocaleTimeString();
                        markWS();

                        if (!Number.isFinite(p)) return;

                        if (stream === 'btcusdt@trade') {
                            const prev = lastBtc;
                            const dir = prev == null ? 0 : (p > prev ? 1 : p < prev ? -1 : 0);
                            const delta = prev == null ? NaN : (p - prev);
                            lastBtc = p;
                            if (els.btc) { els.btc.innerText = fmtUSD(p, 2); flashPrice(els.btc, dir); }
                            setLast('btc-last', `ws ${nowStr}`);
                            setDelta('btc-delta', delta);
                            updateMarquee({ btc: lastBtc, eth: lastEth, note: 'WS' });
                        }

                        if (stream === 'ethusdt@trade') {
                            const prev = lastEth;
                            const dir = prev == null ? 0 : (p > prev ? 1 : p < prev ? -1 : 0);
                            const delta = prev == null ? NaN : (p - prev);
                            lastEth = p;
                            if (els.eth) { els.eth.innerText = fmtUSD(p, 2); flashPrice(els.eth, dir); }
                            setLast('eth-last', `ws ${nowStr}`);
                            setDelta('eth-delta', delta);
                            updateMarquee({ btc: lastBtc, eth: lastEth, note: 'WS' });
                        }
                    } catch (e) {
                        // ignore
                    }
                };

                ws.onerror = () => {
                    const nowStr = new Date().toLocaleTimeString();
                    setLast('btc-last', `ws err ${nowStr}`);
                    setLast('eth-last', `ws err ${nowStr}`);
                    setConnBadge('ERR', 'WS ·Äï·Äº·Äø·Äî·Ä¨');
                };

                ws.onclose = () => {
                    const nowStr = new Date().toLocaleTimeString();
                    setLast('btc-last', `ws closed ${nowStr}`);
                    setLast('eth-last', `ws closed ${nowStr}`);
                    setConnBadge('ERR', 'WS ·Äï·Ä≠·Äê·Ä∫·Äû·ÄΩ·Ä¨·Ä∏');
                };

                return ws;
            } catch (e) {
                const nowStr = new Date().toLocaleTimeString();
                setLast('btc-last', `ws fail ${nowStr}`);
                setLast('eth-last', `ws fail ${nowStr}`);
                setConnBadge('ERR', 'WS ·Äô·Äõ');
                return null;
            }
        }

        async function loadPricesREST(preferBinance = false) {
            const nowStr = new Date().toLocaleTimeString();

            if (!preferBinance) {
                // Try CoinGecko first, fallback to Binance
            try {
                const url = 'https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum&vs_currencies=usd';
                const res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) throw new Error('CoinGecko error ' + res.status);
                const data = await res.json();

                const btc = data?.bitcoin?.usd;
                const eth = data?.ethereum?.usd;

                if (typeof btc === 'number') {
                    const prev = lastBtc;
                    const dir = prev == null ? 0 : (btc > prev ? 1 : btc < prev ? -1 : 0);
                    const delta = prev == null ? NaN : (btc - prev);
                    lastBtc = btc;
                    if (els.btc) { els.btc.innerText = fmtUSD(btc, 2); flashPrice(els.btc, dir); }
                    setLast('btc-last', `rest ${nowStr}`);
                    setDelta('btc-delta', delta);
                }

                if (typeof eth === 'number') {
                    const prev = lastEth;
                    const dir = prev == null ? 0 : (eth > prev ? 1 : eth < prev ? -1 : 0);
                    const delta = prev == null ? NaN : (eth - prev);
                    lastEth = eth;
                    if (els.eth) { els.eth.innerText = fmtUSD(eth, 2); flashPrice(els.eth, dir); }
                    setLast('eth-last', `rest ${nowStr}`);
                    setDelta('eth-delta', delta);
                }

                updateMarquee({ btc: lastBtc, eth: lastEth, note: 'REST' });
                markREST();
                return;
            } catch (e) {
                console.warn('CoinGecko REST failed, trying Binance REST:', e);
            }
            }

            try {
                const [btcRes, ethRes] = await Promise.all([
                    fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT', { cache: 'no-store' }),
                    fetch('https://api.binance.com/api/v3/ticker/price?symbol=ETHUSDT', { cache: 'no-store' }),
                ]);

                if (!btcRes.ok || !ethRes.ok) throw new Error('Binance error');

                const btc = Number((await btcRes.json())?.price);
                const eth = Number((await ethRes.json())?.price);

                if (Number.isFinite(btc)) {
                    const prev = lastBtc;
                    const dir = prev == null ? 0 : (btc > prev ? 1 : btc < prev ? -1 : 0);
                    const delta = prev == null ? NaN : (btc - prev);
                    lastBtc = btc;
                    if (els.btc) { els.btc.innerText = fmtUSD(btc, 2); flashPrice(els.btc, dir); }
                    setLast('btc-last', `rest ${nowStr}`);
                    setDelta('btc-delta', delta);
                } else {
                    setLast('btc-last', `rest err ${nowStr}`);
                    setDelta('btc-delta', NaN);
                }

                if (Number.isFinite(eth)) {
                    const prev = lastEth;
                    const dir = prev == null ? 0 : (eth > prev ? 1 : eth < prev ? -1 : 0);
                    const delta = prev == null ? NaN : (eth - prev);
                    lastEth = eth;
                    if (els.eth) { els.eth.innerText = fmtUSD(eth, 2); flashPrice(els.eth, dir); }
                    setLast('eth-last', `rest ${nowStr}`);
                    setDelta('eth-delta', delta);
                } else {
                    setLast('eth-last', `rest err ${nowStr}`);
                    setDelta('eth-delta', NaN);
                }

                updateMarquee({ btc: lastBtc, eth: lastEth, note: 'REST' });
                markREST();
            } catch (e) {
                console.error('REST price load failed:', e);
                setLast('btc-last', `rest err ${nowStr}`);
                setLast('eth-last', `rest err ${nowStr}`);
                setDelta('btc-delta', NaN);
                setDelta('eth-delta', NaN);
                updateMarquee({ btc: null, eth: null, note: 'ERR' });
                markERR('API ·Äô·Äõ');
            }
        }

        // Start WS (best). If WS is blocked/closed, fallback to Binance REST every ~2s.
        startBinanceWS();
        loadPricesREST(true);

        setInterval(() => {
            if (Date.now() - wsLastTs > 5000) loadPricesREST(true);
        }, 2000);

        // === Gold/Oil now use TradingView widgets (same pattern as crypto-live-tracker) ===
        // === Yangon Weather ===
        async function fetchWeather() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=16.8053&longitude=96.1561&current_weather=true', { cache: 'no-store' });
                if (!res.ok) throw new Error('Weather API failed');
                const data = await res.json();
                if (els.weather) els.weather.textContent = `üå§Ô∏è YGN: ${data?.current_weather?.temperature ?? 'N/A'}¬∞C`;
            } catch (e) {
                if (els.weather) els.weather.textContent = 'üå§Ô∏è YGN: N/A';
            }
        }
        fetchWeather();

        // === News injector (safe) ===
        function injectNews(newsArray) {
            if (!els.newsFeed) return;

            if (!Array.isArray(newsArray) || newsArray.length === 0) {
                els.newsFeed.innerHTML = '<p class="text-center text-gray-500 font-[Padauk]">·Äû·Äê·ÄÑ·Ä∫·Ä∏·Äê·Ä≠·ÄØ·Äô·Äª·Ä¨·Ä∏ ·Äô·Äõ·Äæ·Ä≠·Äû·Ä±·Ä∏·Äï·Ä´</p>';
                return;
            }

            let html = '';
            newsArray.forEach((item, index) => {
                const tag = (item?.tag ?? 'MARKET').toString();
                const time = (item?.time ?? '').toString();
                const text = (item?.text ?? '').toString();

                let colorClass = 'text-blue-400 bg-blue-500/10';
                if (tag === 'ETHEREUM' || tag === 'ETH') colorClass = 'text-purple-400 bg-purple-500/10';
                if (tag === 'MARKET' || tag === 'General') colorClass = 'text-yellow-400 bg-yellow-500/10';

                html += `
                <div class="news-card p-5 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 transition cursor-pointer group mb-3" style="animation-delay: ${index * 0.15}s">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold tracking-wider ${colorClass} px-2 py-0.5 rounded uppercase font-sans">${tag}</span>
                        <span class="text-[10px] text-gray-400 font-[Padauk]">${time}</span>
                    </div>
                    <h4 class="text-[15px] font-medium text-gray-100 leading-relaxed group-hover:text-blue-300 transition font-[Padauk] tracking-wide">${text}</h4>
                </div>`;
            });

            els.newsFeed.innerHTML = html;
        }

        // === AI Insights ===
        function safeTime(ts) {
            // support ISO strings / timestamps
            try { return new Date(ts).toLocaleTimeString(); } catch { return ''; }
        }

        function buildAdvice(data) {
            const tips = [];
            const p = lastBtc;
            const s = Number(data?.support);
            const r = Number(data?.resistance);

            if (Number.isFinite(p) && Number.isFinite(s) && p <= s * 1.01) {
                tips.push(`Support (${fmtUSD(s, 0)}) ·Äî·ÄÆ·Ä∏·Äï·Äº·ÄÆ ‚Äî bounce confirm (price action/volume) ·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äï·Äº·ÄÆ·Ä∏·Äô·Äæ ·Äù·ÄÑ·Ä∫·Äï·Ä´·Åã SL ·ÄÄ·Ä≠·ÄØ support ·Ä°·Ä±·Ä¨·ÄÄ·Ä∫·Äî·Ää·Ä∫·Ä∏·Äî·Ää·Ä∫·Ä∏·Äë·Ä¨·Ä∏·Äï·Ä´·Åã`);
            } else if (Number.isFinite(p) && Number.isFinite(r) && p >= r * 0.99) {
                tips.push(`Resistance (${fmtUSD(r, 0)}) ·Äî·ÄÆ·Ä∏·Äï·Äº·ÄÆ ‚Äî breakout ·Ä°·Äê·Ää·Ä∫·Äï·Äº·ÄØ (close/volume) ·Äô·Äõ·Äæ·Ä≠·Äõ·ÄÑ·Ä∫ pullback ·Äñ·Äº·ÄÖ·Ä∫·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äú·Ä≠·ÄØ·Ä∑ profit lock/·ÄÖ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äï·Ä´·Åã`);
            } else if (Number.isFinite(p) && Number.isFinite(s) && Number.isFinite(r)) {
                tips.push(`Range ·Ä°·Äú·Äö·Ä∫ (${fmtUSD(s, 0)} ~ ${fmtUSD(r, 0)}) ‚Äî setup ·Äô·Äë·ÄΩ·ÄÄ·Ä∫·Äû·Ä±·Ä∏·Äõ·ÄÑ·Ä∫ ·ÄÖ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·ÄÄ·Äº·Ää·Ä∑·Ä∫/DCA ·Äî·Ä≤·Ä∑ ·Äû·Äê·Ä≠·Äë·Ä¨·Ä∏·Äï·Ä´·Åã`);
            } else {
                tips.push('·Ä°·ÄÅ·Äª·ÄÄ·Ä∫·Ä°·Äú·ÄÄ·Ä∫·Äô·Äï·Äº·Ää·Ä∑·Ä∫·ÄÖ·ÄØ·Ä∂·Äû·Ä±·Ä∏·Äú·Ä≠·ÄØ·Ä∑ ·Äú·ÄÄ·Ä∫·Äõ·Äæ·Ä≠ trend ·ÄÄ·Ä≠·ÄØ ·Äû·Äê·Ä≠·Äë·Ä¨·Ä∏·Äï·Äº·ÄÆ·Ä∏ ·ÄÖ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äï·Ä´·Åã');
            }

            tips.push('·Ä°·Äô·Äº·Ä≤ SL/TP ·Äû·Äê·Ä∫·Äô·Äæ·Äê·Ä∫·Äï·Äº·ÄÆ·Ä∏ position size ·ÄÄ·Ä≠·ÄØ ·Äû·ÄÑ·Ä∑·Ä∫·Äê·ÄÑ·Ä∑·Ä∫·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äë·Ä¨·Ä∏·Äï·Ä´·Åã');
            tips.push('·Äô·Äæ·Äê·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫: ·Äí·ÄÆ·Ä°·ÄÄ·Äº·Ä∂·Äï·Äº·ÄØ·ÄÅ·Äª·ÄÄ·Ä∫·ÄÄ ·Äï·Ää·Ä¨·Äõ·Ä±·Ä∏·Äû·Äò·Ä±·Ä¨·Äû·Ä¨ (Not financial advice) ·Äï·Ä´·Åã');

            return tips
                .map(t => `<li class="flex gap-2"><span class="text-blue-400">‚Ä¢</span><span>${t}</span></li>`)
                .join('');
        }

        function renderAIPanel(data) {
            if (!els.aiFeed) return;
            const timeStr = safeTime(data?.timestamp ?? Date.now());
            const adviceItems = Array.isArray(data?.advice)
                ? data.advice.map(t => `<li class="flex gap-2"><span class="text-blue-400">‚Ä¢</span><span>${t}</span></li>`).join('')
                : buildAdvice(data);

            els.aiFeed.innerHTML = `
                <div class="bg-blue-600/10 border border-blue-500/20 p-6 rounded-2xl mb-4 shadow-lg shadow-blue-900/10 animate-in zoom-in duration-300">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-sm font-bold tracking-widest text-blue-400 uppercase">·Äî·Ä±·Ä¨·ÄÄ·Ä∫·ÄÜ·ÄØ·Ä∂·Ä∏ ·Ä°·ÄÅ·Äª·ÄÄ·Ä∫·Äï·Äº</span>
                        <span class="text-xs font-mono text-gray-400 bg-white/5 px-2 py-1 rounded">${timeStr}</span>
                    </div>
                    <h4 class="font-bold text-white text-2xl mb-3 tracking-tight">${data?.title ?? 'AI Update'}</h4>
                    <p class="text-base text-gray-300 leading-relaxed font-[Padauk] border-l-2 border-blue-500 pl-4 py-1">${data?.summary ?? 'AI analysis ·Äô·Äú·Ä¨·Äû·Ä±·Ä∏·Äï·Ä´‚Ä¶'}</p>
                </div>

                <div class="grid grid-cols-2 gap-4 mt-6">
                    <div class="bg-white/5 p-4 rounded-xl border border-white/5 hover:border-white/10 transition">
                        <span class="block text-xs uppercase tracking-wider text-gray-500 mb-1">·ÄÅ·Äî·Ä∑·Ä∫·Äô·Äæ·Äî·Ä∫·Ä∏·ÄÅ·Äª·ÄÄ·Ä∫</span>
                        <span class="text-lg font-bold text-white tracking-tight">${data?.prediction ?? '‚Äî'}</span>
                    </div>
                    <div class="bg-white/5 p-4 rounded-xl border border-white/5 hover:border-white/10 transition">
                        <span class="block text-xs uppercase tracking-wider text-gray-500 mb-1">·Ä°·Äõ·Ä±·Ä∏·ÄÄ·Äº·ÄÆ·Ä∏ Level</span>
                        <div class="flex justify-between text-sm">
                            <span class="text-green-400 font-medium">S: ${data?.support ?? '‚Äî'}</span>
                            <span class="text-red-400 font-medium">R: ${data?.resistance ?? '‚Äî'}</span>
                        </div>
                    </div>
                </div>

                <div class="mt-6 bg-white/5 p-5 rounded-2xl border border-white/5 hover:border-white/10 transition">
                    <div class="text-sm font-bold tracking-tight text-white mb-3 font-[Padauk]">·ÄÄ·Ä≠·ÄØ·Äï·Ä≠·ÄØ·ÄÑ·Ä∫ ·Ä°·ÄÄ·Äº·Ä∂·Äï·Äº·ÄØ·ÄÅ·Äª·ÄÄ·Ä∫</div>
                    <ul class="space-y-2 text-sm text-gray-300 font-[Padauk]">${adviceItems}</ul>
                </div>
            `;
        }

        function parseJSONSafe(text) {
            if (!text) return null;
            try { return JSON.parse(text); } catch {}
            const cleaned = text.replace(/^```json\s*/i, '').replace(/^```\s*/i, '').replace(/```$/i, '').trim();
            try { return JSON.parse(cleaned); } catch {}
            const start = cleaned.indexOf('{');
            const end = cleaned.lastIndexOf('}');
            if (start >= 0 && end > start) {
                try { return JSON.parse(cleaned.slice(start, end + 1)); } catch {}
            }
            return null;
        }

        async function fetchCryptoCompareNews() {
            const res = await fetch('https://min-api.cryptocompare.com/data/v2/news/?lang=EN', { cache: 'no-store' });
            if (!res.ok) throw new Error('News source failed');
            const data = await res.json();
            return (data?.Data ?? []).slice(0, 8).map(x => ({
                title: x?.title ?? '',
                source: x?.source ?? 'news',
                time: new Date((x?.published_on ?? 0) * 1000).toLocaleString(),
                body: x?.body ?? ''
            }));
        }

        async function updateWithOpenRouter() {
            const key = (els.openrouterKey?.value || '').trim();
            if (!key) {
                if (els.updateStatus) els.updateStatus.textContent = 'OpenRouter API Key ·Äë·Ää·Ä∑·Ä∫·Äï·Äº·ÄÆ·Ä∏·Äô·Äæ update ·Äú·ÄØ·Äï·Ä∫·Äï·Ä´·Åã';
                return;
            }

            const selectedModel = (els.modelSelect?.value || 'openrouter/auto').trim();
            localStorage.setItem('openrouter_api_key', key);
            localStorage.setItem('openrouter_model', selectedModel);
            if (els.updateBtn) { els.updateBtn.disabled = true; els.updateBtn.textContent = 'Updating...'; }
            if (els.updateStatus) els.updateStatus.textContent = `·Äû·Äê·ÄÑ·Ä∫·Ä∏·ÄÄ·Ä≠·ÄØ AI ·Äî·Ä≤·Ä∑ ·Äï·Äº·Äî·Ä∫·ÄÖ·ÄØ·Äï·Äº·ÄÆ·Ä∏ update ·Äú·ÄØ·Äï·Ä∫·Äî·Ä±·Äï·Ä´·Äê·Äö·Ä∫... (${selectedModel})`;

            try {
                const rawNews = await fetchCryptoCompareNews();
                const marketSnapshot = {
                    btc: lastBtc,
                    eth: lastEth,
                    gold: 'TVC:GOLD',
                    oil: 'TVC:UKOIL'
                };

                const prompt = `You are a financial news assistant for Myanmar users.\nUse the provided headlines and market snapshot to produce concise Burmese updates.\nReturn STRICT JSON only with this schema:\n{\n  "title": string,\n  "summary": string,\n  "prediction": string,\n  "support": string,\n  "resistance": string,\n  "advice": string[],\n  "news": [{"tag": string, "time": string, "text": string}]\n}\nRules:\n- news must contain 3 to 5 items, Burmese text, short and clear.\n- no markdown.\n- keep advice practical and risk-aware.\nInput headlines: ${JSON.stringify(rawNews)}\nMarket snapshot: ${JSON.stringify(marketSnapshot)}`;

                const r = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${key}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'Trading Dashboard'
                    },
                    body: JSON.stringify({
                        model: selectedModel,
                        temperature: 0.4,
                        messages: [{ role: 'user', content: prompt }]
                    })
                });

                if (!r.ok) {
                    const errText = await r.text();
                    throw new Error(`OpenRouter error: ${r.status} ${errText.slice(0, 140)}`);
                }

                const out = await r.json();
                const content = out?.choices?.[0]?.message?.content ?? '';
                const parsed = parseJSONSafe(content);
                if (!parsed) throw new Error('AI output JSON parse failed');

                injectNews(parsed.news);
                renderAIPanel({ ...parsed, timestamp: Date.now() });
                if (els.updateStatus) els.updateStatus.textContent = `·Äï·Äº·ÄÆ·Ä∏·Äï·Ä´·Äï·Äº·ÄÆ ‚Äî ${new Date().toLocaleTimeString()} ·Äô·Äæ·Ä¨ update ·Äú·ÄØ·Äï·Ä∫·Äï·Äº·ÄÆ·Ä∏·Åã`;
            } catch (e) {
                console.error(e);
                if (els.updateStatus) els.updateStatus.textContent = `Update ·Äô·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·Äï·Ä´: ${e.message}`;
            } finally {
                if (els.updateBtn) { els.updateBtn.disabled = false; els.updateBtn.textContent = 'üß† ·Äû·Äê·ÄÑ·Ä∫·Ä∏ Update ·Äê·ÄÑ·Ä∫·Äô·Äö·Ä∫'; }
            }
        }

        async function loadInitialFallback() {
            try {
                const url = `data/ai_analysis.json?t=${Date.now()}`;
                const res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) return;
                const data = await res.json();
                injectNews(data?.news);
                renderAIPanel(data);
            } catch {}
        }

        const savedKey = localStorage.getItem('openrouter_api_key') || '';
        const savedModel = localStorage.getItem('openrouter_model') || 'openrouter/auto';
        if (els.openrouterKey) els.openrouterKey.value = savedKey;
        if (els.modelSelect) {
            els.modelSelect.value = savedModel;
            els.modelSelect.addEventListener('change', () => {
                localStorage.setItem('openrouter_model', els.modelSelect.value);
            });
        }
        if (els.updateBtn) els.updateBtn.addEventListener('click', updateWithOpenRouter);

        // Manual mode: no auto AI refresh.
        loadInitialFallback();
    </script>
</body>
</html>